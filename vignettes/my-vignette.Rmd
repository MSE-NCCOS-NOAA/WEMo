---
title: "Getting Started with WEMo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with WEMo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(6, 4),
  fig.align = 'center'
)

library(WEMo)
```

## About WEMo

**WEMo (Wave Exposure Model)** uses linear wave theory to estimate wave height and wave energy while accounting for local water depth effects like shoaling and wave breaking.

Originally written in [insert original language], WEMo previously depended on ESRIâ€™s ArcGIS. This R implementation removes that dependency, making the model more accessible and license-free.

WEMo requires four key inputs:

* A bathymetry raster

* A shoreline polygon

* A summarized wind history

* A set of site points where wave exposure will be calculated

The package also includes functions for preparing inputs, summarizing wind data, calculating fetch, and visualizing results.

Original Version of WEMo: <https://coastalscience.noaa.gov/science-areas/climate-change/wemo/>

## Input Data Overview

### Bathymetry

Bathymetry describes underwater terrain, influencing wave growth and breaking. WEMo expects bathymetry as a raster (GeoTIF `.tif`), typically in meters relative to a vertical datum like NAVD88. 

### Shoreline

The shoreline defines the land-water boundary for fetch calculations. It should be an `sf` polygon. You can either supply your own shoreline shapefile or generate one from your bathymetry raster using the `shoreline_from_bathy()` function.

### Wind

WEMo is a wind-wave only model, other sources of waves like tides and storms are not considered. 

WEMo expects a summary of wind history not raw observations. 

This summarized history must include:

-   **`direction`**: The direction *from* which the wind blows (degrees off North, like a compass)

-   **`proportion`**: Fraction of time wind comes from each direction

-   **`speed`**: Wind speed used for wave generation (e.g., mean or percentile)

Use `get_wind_data()` to download wind history and `summarize_wind_data()` to summarize them for WEMo.

### Site Points

Site points define where WEMo will compute wave exposure. Supply as an `sf` point object.

For broader spatial coverage, create a grid using `generate_grid_points()`.

# Running WEMo

## Installation

```{}
# Ensure you have the remotes package installed, if not download and install it
if(!require(remotes)) install.packages("remotes")

# Download WEMo from github
if(!require(WEMo)) remotes::install_github("QAWalker/WEMo")

```

## Load Libraries

```{r load libraries}
# Load WEMo into your environment
library(WEMo)

# We use terra for raster data handling
library(terra)

# We use sf for other spatial data handling
library(sf)

# We use ggplot2 to create visualizations
library(ggplot2)

# We use tidyterra to help ggplot2 with objects created in terra
library(tidyterra)

# we also set the default theme for plotting
theme_set(theme_minimal())
```

## Load our input data

### Bathymetry

This raster should cover the full extent of the area that you might expect to be reached by fetch rays from your site. Processing time can be sped up by cropping this raster.

```{r read bathy data}
bathy <- terra::rast( "~/R/My Packages/WEMo/inst/extdata/PI_bathy.tif")

```

### Shoreline and points

```{r load wind, points and shoreline, include = FALSE}

load("~/R/My Packages/outdated functions/data temp storage/data/points.rda")
load("~/R/My Packages/outdated functions/data temp storage/data/shoreline.rda")

wind_data <- read.csv("~/R/My Packages/WEMo/inst/extdata/PI_winddata.csv")
```

```{r dummy import points and shoreline, eval = FALSE}
points <- sf::st_read("~/R/My Packages/WEMo/inst/extdata/PI_points.shp")

shoreline <- sf::st_read("~/R/My Packages/WEMo/inst/extdata/PI_shoreline_MHHW.shp")
```

### Plot Input Spatial Data

```{r plot shoreline and points}
ggplot()+
  geom_spatraster(data = bathy)+
  geom_sf(data = shoreline, fill = "honeydew3")+
  geom_sf(data = points, color = 'red')+
  labs(fill = "Bathymetry (m NAVD88)")

```

### Wind

To download wind data:

```{r download wind dummy, eval = FALSE}
wind_data <- get_wind_data(points, 2023:2024, which_station = "ask")

```

*NOTE: `get_wind_data()` uses the package `worldmet` <https://openair-project.github.io/worldmet/> to access NOAA Integrated Surface Database (ISD) meteorological observations data.*

With the argument `which_station` set to `"ask"` you'll be prompted to select a weather station (and an interactive map to see where they are in relation to each other):

```         
Choose a met station
Available stations: 

1: 994975-99999 BEAUFORT  NC (0.5 km), 2008-01-01 to 2025-06-25
2: 723037-93765 MICHAEL J SMITH FLD ARPT (2.7 km), 2006-01-01 to 2025-06-26
3: 994160-99999 CAPE LOOKOUT  NC (17.2 km), 1985-01-20 to 2025-06-25
4: 723090-13754 CHERRY POINT MCAS (28 km), 1973-01-01 to 2025-06-26
5: 723097-93743 BOGUE FIELD MARINE CORPS AUXILIARY FIELD (32.8 km), 1987-05-04 to 2025-06-26

Selection:
```

Enter the number of the station what you would like to download and then data will download and be ready to be saved to disk or moved through the workflow.

Inspect `wind_data`:

```{r look at wind data}
head(wind_data)
```

There's a time and date associated with each observed `wind_direction` and `wind_speed`.

WEMo wants a summary of the wind history data i.e. one proportion and speed value for each direction. Use `summarize_wind_data()` to calculate the 95th percentile wind speed every 10 degrees

```{r summarize wind, eval = T}
# create a vector from 0 to 350 by 10 to snap the input wind_directions to
wanted_directions <- seq(from = 0, to = 350, by = 10)

wind_data_summary <- summarize_wind_data(
  wind_data = wind_data,
  wind_percentile = 0.95,
  directions = wanted_directions
)

head(wind_data_summary)
```

Plot the summarized wind  as a wind rose:

```{r plot summarized wind data in a wind rose, eval=TRUE}
wind_rose_plot <- wind_rose(wind_data = wind_data_summary)

# update the title, subtitle and fill description and change the color scale for the filled bars
wind_rose_plot <- wind_rose_plot +
  labs(
    title = "Pivers Island Wind History", 
    subtitle = "2023-2024",
    fill = "95th %tile Wind\nSpeed (m/s)"
  ) +
  scale_fill_viridis_c(option = "C")

wind_rose_plot
```
*NOTE: `wind_rose()` creates a `ggplot` object that can be saved or further manipulated to match your needs. Read more about controlling and customizing plots in `ggplot2` here: <https://ggplot2.tidyverse.org/>*

Save the plot:

```{r save wind rose, eval = FALSE}
ggsave(
  wind_rose_plot,
  height = 4,
  width = 5,
  units = 'in',
  dpi = 150,
  filename = "~/path/to/save/plot.png"
)
```

## Run WEMo with `wemo_full()`

```{r run wemo, eval = TRUE}
wemo_output <- wemo_full(
  site_points = points,
  shoreline = shoreline,
  bathy = bathy,
  wind_data = wind_data_summary,
  directions = wanted_directions,
  max_fetch = 1000,
  sample_dist = 10,
  water_level = 0.552,
  depths_or_elev = "elev",
  extra_at_start = TRUE
)

head(wemo_output)
```

## Vizualing Results

`wemo_full()` returns:

* **`wemo_details`** wave info for each fetch ray. Line geometry.
* **`wemo_final`** contains a summary of wave energy environment at each site. Spatial geometry are points representing the sites.

Both `wemo_details` and `wemo_final` are spatial objects that can be plotted and saved. 

### Plotting Results

Lets do that now starting with `wemo_final`. We'll use the argument `aes(color = RWE)` to tell ggplot to color the points by the RWE:

```{r plot final results}
ggplot()+
  geom_spatraster(data = bathy) +
  geom_sf(data = shoreline, fill = "honeydew3") +
  geom_sf(data = wemo_output$wemo_final, aes(color = RWE), size = 3)+
  scale_color_viridis_c(option = "D")+
  labs(color = "RWE (j/m)", 
       fill = "Bathymetry (m NAVD88)")

```

Most user will probably only want the data from `wemo_final`, but `wemo_details` is may be useful to visualize the fetch rays and to inspect if you're curious. Let's take a look:

```{r plot fetch ray results}
ggplot()+
  geom_spatraster(data = bathy) +
  geom_sf(data = shoreline, fill = "honeydew3") +
  geom_sf(data = wemo_output$wemo_details, aes(color = wave_height_final))+
  scale_color_viridis_c(option = "C")+
  labs(color = "Wave Height (m)", 
       fill = "Bathymetry (m NAVD88)")

```

Notice how the fetch rays do not reach all the way to the shoreline in some directions? These are effective or cosine weighted fetch rays. They are constrained by the fetch rays that surround them. [Do i need effective fetch explanation or can I refer to more source?]. Additionally, the parameter `max_fetch` constrains the maximum distance that fetch rays are drawn. If you'd like to plot or save the full fetch rays the function `find_fetch()` creates the fetch rays and returns a object that can be saved or plotted.

### Save Results

You can save these spatial objects as shapefiles to send to other GIS applications or to be used later.

```{r, eval=FALSE}
sf::st_write(wemo_output$wemo_details, "/path/to/save/wemo_details.shp")

sf::st_write(wemo_output$wemo_final, "/path/to/save/wemo_final.shp"
```

You can also turn the final results to a data.frame to be saved as a .csv file

```{r, eval=FALSE}
results_df <- st_drop_geometry(wemo_output$wemo_final)


write.csv(results_df, file = "/path/to/save/results.csv")
```


# Re-running With More Data

`wemo_full()` is great because it doesn't require working with any intermediate products of WEMo. But what if you'd like to see how the model output changes with a different wind regime or if there's 30cm of sea level rise? Re-running `wemo_full()` with new input is a fine way to do this, but it does ask your computer to duplicate compute intensive tasks that you've already done. These tasks like drawing fetch lines and interrogating the bathymetry layer can be done once and the results saved to make the process of running WEMo again much faster. 

## Prepare Input Data

The function `prepare_WEMo_inputs()` chains together the core components needed to prepare a dataset for WEMo modelling. It calculates fetch lines, effective fetch, interrogates bathymetry, and merges wind data. The return is a spatial object ready for wave modeling.

You'll notice the arguments here are identical to what we fed into `wemo_full()` earlier.

```{r create inputs}
inputs <- prepare_WEMo_inputs(
  site_points = points,
  shoreline = shoreline,
  bathy = bathy,
  wind_data = wind_data_summary,
  directions = wanted_directions,
  max_fetch = 1000,
  sample_dist = 10,
  water_level = 0.552,
  depths_or_elev = "elev",
  extra_at_start = TRUE
)

inputs
```

## Run the model

At this point you have a prepared dataset called `input` that's ready to be modeled. You can send this dataset to the function `wemo()` to the run the model on this input data.

```{r run wemo on inputs}
results <- WEMo(fetch = inputs)

head(results)
```

You'll notice this results in the same output as `wemo_full()`.

## Update input data

*[maybe I should make these functions so that they're easy to use and users don't have to do coding etc?]*

But what if we wanted to see how the model changes if sea level rises 30 cm? To do this we included a convenience `update_depths()` that will increase the depths stored in our `inputs` object by `depth_diff`. If you use a negative value for `depth_diff` the depths will decrease. Lets increase the water level by 30 cm (0.3 m) and send those values to `wemo()`.

```{r add SLR to input data}
# add 0.3 m to each depth value
inputs_SLR <- update_depths(inputs, depth_diff = 0.3)

# and then re-run WEMo with 0.30 m of sea level rise.
results_SLR <- WEMo(inputs_SLR)

head(results_SLR$wemo_final)
```

Lets compare to our previous results

```{r}
data.frame(
  site = results$wemo_final$site,
  max_wave_height = round(results_SLR$wemo_final$max_wave_height - results$wemo_final$max_wave_height, digits = 3),
  avg_wave_height = round(results_SLR$wemo_final$avg_wave_height - results$wemo_final$avg_wave_height, digits = 3),
  RWE = round(results_SLR$wemo_final$RWE - results$wemo_final$RWE, digits = 3)
)
```

We see a slight increase in wave heights and RWE from raising sea level. Note we didn't change our shorelines and were already running the model at MHHW meaning waves from out original run likely didn't experience breaking or shoaling -- both possible reasons why we don't see a dramatic effect on the results.

What if we wanted to see how the results changed with stronger winds? I'll increase the 95th percentile wind we calculated earlier increased by 25%.

```{r run wemo on more windy data}
# Create a copy of the inputs
inputs_windy <- inputs
# Increase wind speed by 25%
inputs_windy$speed <- inputs_windy$speed * 1.25
# rerun wemo with new data
results_windy <- WEMo(inputs_windy)

data.frame(
  site = results$wemo_final$site,
  max_wave_height = round(results_windy$wemo_final$max_wave_height - results$wemo_final$max_wave_height, digits = 3),
  avg_wave_height = round(results_windy$wemo_final$avg_wave_height - results$wemo_final$avg_wave_height, digits = 3),
  RWE = round(results_windy$wemo_final$RWE - results$wemo_final$RWE, digits = 3)
)
```

We see increases in wave heights up to 5 cm for max wave heights and 3.5 cm for average wave heights. Also see a corresponding increase in RWE.
