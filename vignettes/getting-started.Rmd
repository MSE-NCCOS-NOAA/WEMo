---
title: "Getting Started With WEMo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started With WEMo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(6, 4),
  fig.align = 'center'
)

```

```{r, include = FALSE}
if (!requireNamespace("tidyterra", quietly = TRUE)) {
  knitr::opts_chunk$set(eval = FALSE)
  message("tidyterra not installed — vignette chunks won't run.")
}
```

## About WEMo

**WEMo (Wave Exposure Model)** is an R package that implements a simplified hydrodynamic model to quantify wind-wave exposure in coastal and inland waters. It uses linear wave theory to estimate wave height and energy, accounting for local water depth effects like shoaling and wave breaking. It combines wind data, shoreline geometry, and bathymetry to estimate wave conditions through a reproducible and scriptable workflow in R.

This package provides a modern, open-source, and accessible implementation of the original WEMo, which was developed by NOAA’s Center for Coastal Fisheries and Habitat Research and previously required a proprietary plug-in for ESRI’s ArcMap software. As the original tool is no longer compatible with modern GIS software, this R package provides a sustainable and license-free path forward for researchers and resource managers.

In addition to the core modeling functionality, this package provides dynamic tools for gathering and preparing input data and visualizing results.

More info on the original WEMo here: 
<https://coastalscience.noaa.gov/science-areas/climate-change/wemo/>

## Input Data Overview

WEMo requires four key inputs:

* A bathymetry raster

* A shoreline polygon

* A summarized wind history

* A set of site points for which wave exposure will be calculated

### Bathymetry

Bathymetry describes underwater terrain, which influences wave growth and breaking. WEMo requires bathymetry as a raster (GeoTIF `.tif`), typically in meters relative to a vertical datum like NAVD88. 

The function `get_noaa_cudem()` provides access to NOAA's Continuously Updated Digital Elevation Model [CUDEM](https://www.ncei.noaa.gov/products/coastal-elevation-models) (<https://www.ncei.noaa.gov/products/coastal-elevation-models>) allowing users to quickly download and incorporate CUDEM topobathy data in their workflow.

### Shoreline

The shoreline defines the land-water boundary which is critical for fetch calculations. 

The function `generate_shoreline_from_bathy()` generates a shoreline polygon at a user defined contour on your input bathymetric raster. 

### Wind

WEMo is a local wind-wave only model, other sources of waves like tides and seiche are not considered. 

The function `get_wind_data()` gives users access to [NOAA’s integrated surface dataset](https://www.ncei.noaa.gov/products/land-based-station/integrated-surface-database) (via the [worldmet](https://openair-project.github.io/worldmet/) package) to retrieve wind data for use in WEMo. Users can select a station, either interactively or by providing an index or station code.

The function `summarize_wind_data()` prepares wind data to be used by WEMo by cleaning and summarizing data from `get_wind_data()`.

### Site Points

Site points define where WEMo will compute wave exposure. 

Users can read in their own points as shapefiles or create a grid of points around coordinates using `generate_grid_points()`.

# Running WEMo

## Installation

```{r, eval=FALSE}
# Ensure you have the remotes package installed, if not download and install it
if(!require(remotes)) install.packages("remotes")

# Download the latest version of WEMo from github
remotes::install_github("QAWalker/WEMo")

```

## Load Libraries

```{r load libraries, results='hide', warning=FALSE, message=FALSE}
# Load WEMo into your environment
library(WEMo)

# We use terra for raster data handling
library(terra)

# We use sf for other spatial data handling
library(sf)

# We use ggplot2 to create visualizations
library(ggplot2)

# We use tidyterra to help ggplot2 with objects created in terra
library(tidyterra)

# we also set the default theme for plotting
theme_set(theme_minimal())
```

## Load our input data

A suite of example data is included with WEMo. The data are from the area around Pivers Island, Beaufort, North Carolina.

### Bathymetry

This raster should cover the full extent of the area that you might expect to be reached by fetch rays from your site. 

```{r read bathy data}
# load bathymetry
PI_bathy <- terra::rast(x = system.file("extdata", "PI_bathy.tif", package = "WEMo"))

# plot the bathy raster
ggplot() +
  geom_spatraster(data = PI_bathy)+
  labs(fill = "Bathymetry (m NAVD88)")
```

### Site Points

```{r import and plot points}
# Plot site points
# PI_Points is a sf object containing 3 points
ggplot()+
  geom_sf(data = PI_points, color = "red", size = 3)
```

### Shoreline

```{r import and plot shoreline}
# Plot shoreline
# PI_shoreline is a polygon representing the MHHW shoreline (0.552 m NAVD88)
ggplot()+
  geom_sf(data = PI_shoreline, fill = "honeydew3")
```

### Plot All Input Spatial Data

```{r plot shoreline and points}
# plot all input spatial data
ggplot()+
  geom_spatraster(data = PI_bathy)+
  geom_sf(data = PI_shoreline, fill = "honeydew3")+
  geom_sf(data = PI_points, color = 'red')+
  labs(fill = "Bathymetry (m NAVD88)")

```

### Wind

```{r inspect example wind data, results='markup'}
# View first several rows of wind data
# PI_wind_data contains local wind observations from 2023 - 2024
head(PI_wind_data)
```

WEMo wants a summary of the wind history data i.e. one proportion and speed value for each direction.

```{r summarize wind, eval = T}
# Summarizing wind data
# create a vector from 0 to 350 by 10 to snap the input wind_directions to
wanted_directions <- seq(from = 0, to = 350, by = 10)

# calculate the 95th percentile wind speed every 10 degrees
# Using 95 percentile as an example, but the wind speed of interest will change depending on your use case
wind_data_summary <- summarize_wind_data(
  wind_data = PI_wind_data,
  wind_percentile = 0.95,
  directions = wanted_directions
)

# View first several rows of summarized wind data
head(wind_data_summary)
```

Plot the summarized wind data as a wind rose:

```{r plot summarized wind data in a wind rose, eval=TRUE}
# Plot wind data summary as a wind rose
wind_rose_plot <- plot_wind_rose(wind_data = wind_data_summary)

# update the title, subtitle and fill description and change the color scale for the filled bars
wind_rose_plot <- wind_rose_plot +
  labs(
    title = "Pivers Island Wind History", 
    subtitle = "2023-2024",
    fill = "95th %tile Wind\nSpeed (m/s)"
  ) +
  scale_fill_viridis_c(option = "C")

wind_rose_plot
```
*NOTE: `plot_wind_rose()` creates a `ggplot` object that can be saved or further manipulated to match your needs. Read more about controlling and customizing plots in `ggplot2` here: <https://ggplot2.tidyverse.org/>*

# Run WEMo with `wemo_full()`

Now that all of our input data is gathered and inspected we're ready to run the model. In this example, WEMo will:

* Model wind waves at each point in `PI_points.`
* Use `PI_shoreline` as the shoreline for drawing fetch rays.
* Use the raster `PI_bathy` as the bathymetry that waves interact with as they approach the points.
* Apply the summarized wind information in `wind_data_summary`, which provides the intensity and frequency of wind from each of the `wanted_directions.`

We also set a few modeling parameters:

* `max_fetch = 10000`: the maximum length (in meters) of fetch rays.
* `sample_dist = 1`: the spacing (in meters) at which bathymetry is sampled and the wave is built along each ray.
* `water_level = 0.552`: the water level (in the same units as the bathymetry raster). This is mean higher high water for this site
* `depths_or_elev = "elev"`: indicates that the bathymetry file stores elevations (not water depths).


```{r run wemo, eval = TRUE}
wemo_output <- wemo_full(
  site_points = PI_points,
  shoreline = PI_shoreline,
  bathy = PI_bathy,
  wind_data = wind_data_summary,
  directions = wanted_directions,
  max_fetch = 10000,
  sample_dist = 1,
  water_level = 0.552,
  depths_or_elev = "elev"
)

```

`wemo_full()` returns two objects
```{r}
names(wemo_output)
```

`wemo_final` contains the summary stats at each site

```{r}
wemo_output$wemo_final

# wemo_output$wemo_final can be plotted with input data 
ggplot()+
  geom_sf(data = PI_shoreline)+
  geom_sf(data = wemo_output$wemo_final, aes(color = avg_wave_height), size = 5)+
  scale_color_viridis_c(option = "D")
```

`wemo_details` contains stats about the waves from each fetch ray

```{r}
head(wemo_output$wemo_details)

# wemo_output$wemo_details can be plotted with input data 
ggplot()+
  geom_sf(data = PI_shoreline)+
  geom_sf(data = wemo_output$wemo_details, aes(color = wave_height_final), linewidth = 1)+
  scale_color_viridis_c(option = "H")
```

*NOTE: Notice how the fetch rays do not reach all the way to the shoreline in some directions? These are effective or cosine weighted fetch rays. They are constrained by the fetch rays that surround them. Additionally, the parameter `max_fetch` constrains the maximum distance that fetch rays are drawn. If you'd like to plot or save the full fetch rays the function `find_fetch()` creates the fetch rays and returns a object that can be saved or plotted.* 
**[Do i need this effective fetch explanation or can I refer to more source?].**

Most users will probably only want the data from `wemo_final`, but `wemo_details` can be useful to understand why the results in `wemo_final` are what they are.

## Saving Results

```{r, eval=FALSE}
sf::st_write(wemo_output$wemo_details, "/path/to/save/wemo_details.shp")
sf::st_write(wemo_output$wemo_final, "/path/to/save/wemo_final.shp")

# Export as CSV
results_df <- st_drop_geometry(wemo_output$wemo_final)
write.csv(results_df, "/path/to/save/results.csv")
```

# Re-Running With Modified Inputs

`wemo_full()` is great because it doesn't require working with any intermediate products of WEMo. But what if you'd like to see how the model output changes with a different wind regime or with sea level rise? Running `wemo_full()` again works, but re-computes fetch and bathymetry each time.

For faster iteration, prepare inputs once: 

```{r create inputs}
inputs <- prepare_wemo_inputs(
  site_points = PI_points,
  shoreline = PI_shoreline,
  bathy = PI_bathy,
  wind_data = wind_data_summary,
  directions = wanted_directions,
  max_fetch = 1000,
  sample_dist = 10,
  water_level = 0.552,
  depths_or_elev = "elev"
)

```

Then run the model:

```{r}
results <- wemo(fetch = inputs)
```

## Example: Adding Sea Level Rise

```{r add SLR to input data}
# add 0.3 m to each depth value
inputs_SLR <- update_depths(inputs, depth_diff = 0.3)
results_SLR <- wemo(inputs_SLR)

# compare to previous results
data.frame(
  site = results$wemo_final$site,
  max_wave_height = round(results_SLR$wemo_final$max_wave_height - results$wemo_final$max_wave_height, 3),
  avg_wave_height = round(results_SLR$wemo_final$avg_wave_height - results$wemo_final$avg_wave_height, 3),
  RWE = round(results_SLR$wemo_final$RWE - results$wemo_final$RWE, 3)
)
```

We see a slight increase in wave heights and RWE from raising sea level. Note we didn't change our shorelines and were already running the model at MHHW meaning waves from out original run likely didn't experience breaking or shoaling -- both possible reasons why we don't see a dramatic effect on the results.

## Example: Stronger Winds

```{r run wemo on more windy data}
# Create a copy of the inputs
inputs_windy <- inputs
# Increase wind speed by 25%
inputs_windy$speed <- inputs_windy$speed * 1.25

results_windy <- wemo(inputs_windy)

# compare to previous results
data.frame(
  site = results$wemo_final$site,
  max_wave_height = round(results_windy$wemo_final$max_wave_height - results$wemo_final$max_wave_height, digits = 3),
  avg_wave_height = round(results_windy$wemo_final$avg_wave_height - results$wemo_final$avg_wave_height, digits = 3),
  RWE = round(results_windy$wemo_final$RWE - results$wemo_final$RWE, digits = 3)
)
```

We see increases in wave heights up to 5 cm for max wave heights and 3.5 cm for average wave heights. Also see a corresponding increase in RWE.

## Comparing Results Senarios

*this is a bit advanced, but a cool visual*

```{r Comparing Results Senarios, fig.dim=c(9, 6)}
# make a data set to combine all results
results_all <- dplyr::bind_rows(
  dplyr::mutate(results$wemo_details, senario = "1. Normal"), 
  dplyr::mutate(results_SLR$wemo_details, senario = "2. SLR"),
  dplyr::mutate(results_windy$wemo_details, senario = "3. 25% Stronger Wind")
)

ggplot()+
  geom_sf(data = results_all, aes(color = wave_height_final), linewidth = 1)+
  scale_color_viridis_c(option = "H")+
  facet_grid(site~senario, labeller = "label_both")+
  theme_bw()
```

```{r cleanup, include=FALSE}
# Clean up NOAA_cudem folder if it exists
if (dir.exists("NOAA_cudem")) {
  unlink(file.path(getwd(), "NOAA_cudem"), recursive = TRUE, force = TRUE)
}
```

