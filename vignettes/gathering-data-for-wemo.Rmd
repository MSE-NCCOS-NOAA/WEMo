---
title: "Gathering WEMo Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

Before running WEMo simulations, you must gather the necessary spatial and environmental input data. This vignette introduces the WEMo functions used to:

* Download historical wind data
* Download bathymetry data
* Generate a shoreline from the bathymetry
* Generate points in a regularly spaced grid

# Gather input data

First, initialize libraries

```{r load libraries}
library(WEMo)

library(sf)

library(terra)

library(ggplot2)

library(tidyterra)
```

## Define Site Point

To demonstrate the process of gathering and prepareing data for WEMo, we'll collect data for an example analysis in Sinepuxent Bay near Assateague Island National Seashore, Maryland. 

```{r create a site_point}
# create a point at an area of interest in Sinepuxent Bay Maryland
site_point <- st_point(c(-75.168008, 38.223823))  %>% 
  st_sfc(crs = 4326) %>% # set CRS to WGS84
  st_sf()

```

You can also load a shapefile created in another GIS application using the `sf::st_read()` function.

## Wind Data

Use `get_wind_data()` to retrieve and download wind observations from the NOAA Integrated Surface Database (ISD). The returned data frame includes timestamps, wind speed (m/s), and direction (degrees). 

```{r download wind data, eval = T}
wind_data <- get_wind_data(site_point, 2020:2023, which_station = 1)

# examine the wind_data
head(wind_data)
```

The `which_station` variable indicates to download the data from the nth closest station to your point. Usually you'll want the closest station (`which_station = 1`), but that might not always be true. For example, if the years of interest are missing or the closest station is not representative of your site.

Setting `which_station` to `"ask"` provides a list and an interactive map of the 5 closest stations and allows you to choose which you'd like.

```{r demo the ask function, eval = F}
wind_data <- get_wind_data(site_point, 2023:2024, which_station = "ask")
```

```         
Choose a met station
Available stations: 

1: 745946-93786 OCEAN CITY MUNICIPAL ARTP (10.3 km), 2006-01-01 to 2025-07-16
2: 998211-99999 OCEAN CITY INLET (12.7 km), 2008-09-15 to 2025-07-14
3: 723980-93720 SALBRY-OCN CTY WICO RGNL AP (32.8 km), 2005-01-01 to 2025-07-16
4: 724020-93739 WALLOPS FLIGHT FACILITY AIRPORT (41.2 km), 1973-01-01 to 2025-07-16
5: 724093-13764 SUSSEX COUNTY AIRPORT (54.5 km), 2006-01-01 to 2025-07-16

```

Type your selection and hit ENTER.

**NOTE:`get_wind_data()` uses the package `worldmet` <https://openair-project.github.io/worldmet/> to access NOAA Integrated Surface Database (ISD) meteorological observations data.**

**For general information of the ISD see https://www.ncei.noaa.gov/products/land-based-station/integrated-surface-database**

### Summarizing Wind Data

WEMo expects a summary of wind history not raw observations. 

This summarized history must include:

-   **`direction`**: The direction *from* which the wind blows (degrees off North, like a compass)

-   **`proportion`**: Fraction of time wind comes from each direction

-   **`speed`**: Wind speed used for wave generation (e.g., mean or percentile)

The function `summarize_wind_data()` to prepares data gathered from the `get_wind_data()` function to be used in WEMo. 

```{r summarize wind, eval = T}
# create a vector from 0 to 350 by 10 to snap the input wind_directions to
wanted_directions <- seq(from = 0, to = 350, by = 10)

# calculate the 95th percentile wind speed every 10 degrees
wind_data_summary <- summarize_wind_data(
  wind_data = PI_wind_data,
  wind_percentile = 0.95,
  directions = wanted_directions
)

head(wind_data_summary)

# make a wind rose
wind_rose(wind_data_summary)
```

Input `wind_direction` values are coerced into values 0-359.9. The function can further snap input `wind_directions` to a user supplied vector of suitable directions (`directions`). Input `wind_directions` are rounded to the nearest value in `directions`. This is often necessary with input data from public data sets that have occasional anomalous readings. If `directions` is not supplied the output is based on all unique values in `wind_data$wind_direction`.

The function will accept `wind_percentile` values from 0 to 1 or `"mean"`. The returned `speed` value indicates the corresponding stat of all observations from that direction.


`NA` values in the `wind_direction` column indicates calm data if the `wind_speed` column is 0. However, `NA` values in the `wind_speed` column are considered bad data and are removed when `wind_speed_na.rm = TRUE` (the default). Here I'll generate random example data and summarize speed to the mean:

```{r demo calm wind}
# create some dummy data with NAs in the speed and direction columns
wind_data_random <- data.frame(
  wind_direction = c(runif(n = 5, min = 0, max = 315),rep(NA, 10)),
  wind_speed = c(runif(5, 0, 25), rep(NA, 5), rep(0, 5))
)

# remove the NAs in the speed column. perhaps these are data collection errors
summarize_wind_data(wind_data_random, wind_percentile = 'mean',
  directions = c(90, 180, 270, 360), wind_speed_na.rm = TRUE)
```

But you can set `wind_speed_na.rm = FALSE` to keep them in as calm readings. Usually only `wind_speeds` of 0 are considered calm data:

```{r more calm demo}
# keep the NAs in the speed column. perhaps these represent calm data
# (though normally 0 would indicate calm)
summarize_wind_data(wind_data_random, wind_percentile = 'mean',
  directions = c(90, 180, 270, 360), wind_speed_na.rm = FALSE)

```

## Bathymetry

There are plenty of sources of bathymetric data and it would be impossible to discuss them here, however NOAA's Bathymetric Data Viewer (https://www.ncei.noaa.gov/maps/bathymetry/) offers an easy to access and interactive viewer to find some of the best publicly available datasets.

We have provided a convenience function `get_noaa_cudem()` to fetch bathymetric data from NOAAâ€™s Continuously Updated Digital Elevation Model (CUDEM). This function accesses data from NOAA's Continuously Updated Digital Elevation Model (CUDEM), specifically the 1/9 Arc-Second Resolution (approx. 3 meter) Topobathymetric dataset https://chs.coast.noaa.gov/htdata/raster2/elevation/NCEI_ninth_Topobathy_2014_8483/. This function takes a input point and radius and downloads topo-bathy .tif raster tiles that intersect that radius.

```{r download bathy data}
# extract lon and lat from our site_point
lon = sf::st_coordinates(site_point)[1]
lat = sf::st_coordinates(site_point)[2]

# download, mosaic and crop CUDEM rasters for our area of interest
bathy <- get_noaa_cudem(
  lon = lon, 
  lat = lat, 
  radius_m = 15000,
  dest_dir = "NOAA_CUDEM",
  mosaic_and_crop = TRUE,
  output_file = "Sinepuxent_Bathy_Cropped.tif", 
  overwrite = TRUE
)

# plot the cropped raster in relation to our site point
ggplot() +
  geom_spatraster(data = bathy) +
  geom_sf(data = site_point, color = 'red', size = 5)

```

The CUDEM dataset accessed by this function covers select areas of the United States, including:

* The East Coast
* The Gulf Coast
* The San Francisco Bay
* Part of the Oregon Coast and the Washington Coast
* The Puget Sound, Washington
* Portions of Cook Inlet, Alaska

Additional CUDEM products, with varying spatial resolutions and geographic extents, are available at: https://www.ncei.noaa.gov/products/coastal-elevation-models

With `mosaic_and_crop = TRUE` the function will stitch together the downloaded rasters and crop them to an area defined by the `radius_m`. This is useful for speeding up processing time by keeping the inputs to WEMo as small as possible. 

With `radius_m = 15000` all topo-bathy data that is within 15,000 meters of our point is fetched. This was value was chosen so that the default max fetch distance that WEMo uses (10,000) will be covered by the raster after additional points in a grid of points 500 by 500 meters around this point is created further down the workflow. [need editing for clarification here?]

With `overwrite = TRUE` all intersecting rasters will be re-downloaded even if they are present in the folde. Set `overwrite = FALSE` to increase speed. 

**NOTE: that `dest_dir` will create a folder in your working directory if one with that name doesn't exist. You can use `getwd()` to determine where your working directory is. You can also include the full path to your desired folder if that isn't in your working directory. The cropped mosaic raster is also saved to the same directory.**

## Shoreline 

Once you have bathymetry data, use `generate_shoreline_from_bathy()` to generate a shoreline based on a user defined elevation.

```{r}
shoreline <- generate_grid_points(site_point)
```



